# robot_safety_and_navigation

**Пакет для безопасного и точного управления движением боевого робота.**

Этот пакет включает в себя две ключевые ноды, работающие в связке:
1.  **`path_follower_pid_node.py`**: Реализует алгоритм следования по пути на основе Pure Pursuit и PID-регулятора.
2.  **`behavior_server_node.py`**: Выступает в роли супервизора безопасности, арбитра команд скорости и управляет логикой состояний робота (например, старт, обнаружение застревания, защита от вращения).

---

## 1. Safety Controller Node (`behavior_server_node`)

Эта нода является **арбитром управления**, находясь между планировщиком пути и драйвером моторов. Она отвечает за инициализацию движения, обнаружение проблем и перехват управления для предотвращения опасного или неэффективного поведения.

### ROS2

| Тип | Топик | Тип сообщения | Описание |
| :--- | :--- | :--- | :--- |
| **Sub** | `/robot_pose` | `geometry_msgs/PoseStamped` | Текущая позиция робота (для анализа истории перемещений). |
| **Sub** | `/pid_follower_cmd_vel` | `geometry_msgs/TwistStamped` | Команды скорости от Path Follower. |
| **Pub** | `/cmd_vel` | `geometry_msgs/TwistStamped` | **Итоговая** команда скорости, отправляемая на контроллер моторов. |

### Логика состояний (State Machine)

Нода работает как конечный автомат:

| Состояние | Поведение | Условие перехода |
| :--- | :--- | :--- |
| `STARTUP_MOVE` | "Слепой" проезд вперед (полезно для съезда с док-станции). | Истечение `startup_move_duration`. |
| `STARTUP_STOPPING`| Пауза для стабилизации одометрии. | Истечение `startup_stop_duration`. |
| `NORMAL` | **Штатный режим.** Трансляция команд от Path Follower. | Переход из `STARTUP_STOPPING`. |
| `UNSTUCK` | Маневр спасения (движение назад) при застревании. | Детекция застревания в `NORMAL`. |
| `STOP_SPINNING` | Принудительная остановка (cooldown). | Детекция превышения `spin_time_limit` в `NORMAL`. |

### Основные Параметры Конфигурации

| Группа | Параметр | Тип | По умолч. | Описание |
| :--- | :--- | :--- | :--- | :--- |
| **Старт** | `enable_startup_move` | `bool` | `true` | Включает "слепой" проезд при запуске. |
| | `startup_move_duration`| `double` | `2.0` | Длительность стартового проезда (сек). |
| **Застревание**| `stuck_time_window` | `double` | `5.0` | Окно анализа истории перемещений (сек). |
| | `stuck_threshold` | `double` | `0.1` | Минимальный прогресс (м), который предотвращает фиксацию застревания. |
| | `unstuck_duration` | `double` | `1.0` | Время маневра спасения (движение назад). |
| **Вращение** | `spin_time_limit` | `double` | `2.0` | Макс. время непрерывного вращения (сек). |
| | `stop_duration` | `double` | `1.5` | Время принудительной остановки после превышения лимита вращения. |
| **Система** | `debug_output_rate` | `double` | `1.0` | Частота вывода отладочной информации (Гц). |

---

## 2. Path Follower Node (`path_follower_pid_node`)

Эта нода реализует алгоритм **следования по пути**, используя гибридную стратегию: **Pure Pursuit** для выбора целевой точки (`lookahead_distance`) и **PID-регулятор** для расчета требуемой угловой скорости ($\omega_{cmd}$).

### ROS2

| Тип | Топик | Тип сообщения | Описание |
| :--- | :--- | :--- | :--- |
| **Sub** | `/robot_pose` | `geometry_msgs/PoseStamped` | Текущая поза робота. |
| **Sub** | `/planned_path` | `nav_msgs/Path` | Запланированный путь, по которому нужно следовать. |
| **Pub** | `/pid_follower_cmd_vel` | `geometry_msgs/TwistStamped` | Команда скорости для Safety Controller. |

### Основные Параметры Конфигурации

| Параметр | Тип | Ед. измерения | По умолч. | Описание |
| :--- | :--- | :--- | :--- | :--- |
| `base_linear_speed`| `float` | м/с | `0.3` | Номинальная линейная скорость движения. |
| `lookahead_distance`| `float` | м | `0.6` | Дистанция "вперед" для выбора целевой точки (**Pure Pursuit**). |
| `kp_angular` | `float` | - | `0.3` | **P**-коэффициент для регулятора угла. |
| `ki_angular` | `float` | - | `0.05` | **I**-коэффициент для регулятора угла. |
| `kd_angular` | `float` | - | `0.2` | **D**-коэффициент для регулятора угла. |
| `max_yaw_rate` | `float` | рад/с | $\approx 0.87$ | Максимально допустимая угловая скорость. |
| `dt` | `float` | с | `0.4` | Период основного управляющего цикла (частота таймера). |

---

## Запуск

Ноды пакета запускаются с помощью стандартной команды `ros2 run`.

### 1. Запуск Safety Controller

```bash
ros2 run behavior_server behavior_server_node

ros2 run behavior_server path_follower_pid_node --ros-args \
  -p kp_angular:=-0.18 \
  -p ki_angular:=-0.0 \
  -p kd_angular:=-0.015 \
  -p lookahead_distance:=0.4 \
  -p base_linear_speed:=0.3
